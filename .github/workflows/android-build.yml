name: Build Android APK

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'        # è§¦å‘ tag å‘å¸ƒ (å¦‚ v1.2.0)
      - '[0-9]*'    # LSPosed æ ¼å¼ (å¦‚ 1002000-1.2.0)
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Generate debug keystore
      run: |
        mkdir -p ~/.android
        keytool -genkey -dname "cn=Android Debug, ou=Android, o=Google, l=Unknown, st=Unknown, c=US" \
          -keystore ~/.android/debug.keystore \
          -storepass android \
          -alias androiddebugkey \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -keypass android

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Get version from gradle.properties
      id: version
      run: |
        VERSION=$(grep "appVersionName" gradle.properties | cut -d'=' -f2)
        # è®¡ç®— versionCode: major * 1000000 + minor * 1000 + hotfix
        MAJOR=$(echo $VERSION | cut -d'.' -f1)
        MINOR=$(echo $VERSION | cut -d'.' -f2)
        HOTFIX=$(echo $VERSION | cut -d'.' -f3)
        VERSION_CODE=$((MAJOR * 1000000 + MINOR * 1000 + HOTFIX))
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        # LSPosed æ ¼å¼: VersionCode-VersionName
        echo "lsposed_tag=${VERSION_CODE}-${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: $VERSION (Code: $VERSION_CODE)"
        echo "LSPosed Tag: ${VERSION_CODE}-${VERSION}"

    - name: Build debug APK
      run: ./gradlew assembleDebug --no-daemon

    - name: Rename APK with version
      run: |
        VERSION=${{ steps.version.outputs.version }}
        mkdir -p release
        cp app/build/outputs/apk/debug/app-debug.apk release/VideoSpeed_${VERSION}.apk
        echo "APK renamed to: VideoSpeed_${VERSION}.apk"

    - name: Upload debug APK (Artifact)
      uses: actions/upload-artifact@v4
      with:
        name: VideoSpeed_${{ steps.version.outputs.version }}
        path: release/VideoSpeed_${{ steps.version.outputs.version }}.apk

    - name: Create GitHub Release (LSPosed Format)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        # ä½¿ç”¨ LSPosed æ ¼å¼çš„ tag: VersionCode-VersionName
        tag_name: ${{ steps.version.outputs.lsposed_tag }}
        name: ${{ steps.version.outputs.lsposed_tag }}
        body: |
          ## è§†é¢‘è°ƒé€Ÿ VideoSpeed v${{ steps.version.outputs.version }}
          
          ### ğŸ“¦ ä¸‹è½½
          - **VideoSpeed_${{ steps.version.outputs.version }}.apk** - Android APK å®‰è£…åŒ…
          
          ### ğŸ“± æ”¯æŒåº”ç”¨
          - å“”å“©å“”å“© Bç«™ (7.25.0 / 3.20.4 GP)
          - å¾®ä¿¡è§†é¢‘å· WeChat (8.0.62 GP)
          - æŠ–éŸ³ Douyin (25.6.0)
          - å°çº¢ä¹¦ (8.23.0.5)
          - Twitter/X (11.20.0)
          - Instagram (315.0.0.29.109)
          - Telegram
          - å¾®åš Weibo (14.6.0)
          
          ### âš ï¸ æ³¨æ„
          - éœ€è¦ Android 8.0 (API 26) æˆ–æ›´é«˜ç‰ˆæœ¬
          - éœ€è¦ LSPosed/Xposed æ¡†æ¶æ”¯æŒ
          
          ### ğŸ™ è‡´è°¢
          - åŸé¡¹ç›®: [V-E-O/biliSpeed](https://github.com/V-E-O/biliSpeed)
          - AIè¾…åŠ©: Cursor + Claude Opus 4.5
        files: |
          release/VideoSpeed_${{ steps.version.outputs.version }}.apk
        generate_release_notes: true
        draft: false
        token: ${{ secrets.GITHUB_TOKEN }}
